<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Aikoshi v2 – Anime & Manga</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' } </script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --primary:#8a2be2; --primary-dark:#6a1cb9; --secondary:#ff3864; --accent:#00c2ba;
      --dark-bg:#0f1014; --dark-card:#151821; --dark-border:#26293a; --text:#f4f4f5; --muted:#a1a1aa;
      --light-bg:#f7fafc; --light-card:#ffffff; --light-border:#e2e8f0; --light-text:#111827; --light-muted:#6b7280;
    }
    html,body{background:var(--dark-bg);color:var(--text);font-family:"Outfit","Inter",system-ui;transition:background-color .2s,color .2s}
    /* Glass surfaces – use data-glass attribute to auto-switch */
    .glass{background:rgba(16,16,24,.8);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
    .glass-light{background:rgba(255,255,255,.85);backdrop-filter:blur(10px);border-bottom:1px solid rgba(0,0,0,.06)}

    .badge{display:inline-flex;align-items:center;padding:.25rem .6rem;border-radius:999px;font-size:.72rem;border:1px solid rgba(255,255,255,.08);background:rgba(39,39,42,.6)}
    .badge-light{display:inline-flex;align-items:center;padding:.25rem .6rem;border-radius:999px;font-size:.72rem;border:1px solid rgba(0,0,0,.08);background:rgba(241,245,249,.8);color:var(--light-text)}
    .badge-18{background:rgba(225,29,72,.18);color:#fecaca;border-color:rgba(225,29,72,.35)}
    .badge-18-light{background:rgba(225,29,72,.18);color:#be123c;border-color:rgba(225,29,72,.35)}
    .badge-score{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
    .card{transition:transform .18s ease, box-shadow .18s ease}
    .card:hover{transform:translateY(-4px)}
    .hero{background:radial-gradient(1200px 600px at 10% -10%,rgba(138,43,226,.22),transparent 60%),radial-gradient(1200px 600px at 90% -10%,rgba(255,56,100,.16),transparent 60%)}
    .hero-light{background:radial-gradient(1200px 600px at 10% -10%,rgba(138,43,226,.12),transparent 60%),radial-gradient(1200px 600px at 90% -10%,rgba(255,56,100,.08),transparent 60%)}
    .hero *{overflow:visible}
    .adult-mode{--primary:#e11d48;--primary-dark:#be123c;--secondary:#fb7185;--accent:#f59e0b}
    .light-mode{--dark-bg:var(--light-bg);--dark-card:var(--light-card);--dark-border:var(--light-border);--text:var(--light-text);--muted:var(--light-muted)}
    *::-webkit-scrollbar{height:8px;width:8px}
    *::-webkit-scrollbar-thumb{background:var(--dark-border);border-radius:8px}
    .skeleton{background:linear-gradient(90deg,#27272a 25%,#3f3f46 50%,#27272a 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:6px}
    .skeleton-light{background:linear-gradient(90deg,#e2e8f0 25%,#f1f5f9 50%,#e2e8f0 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:6px}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}

    /* Theme toggle (visible track + knob) */
    .switch{position:relative;display:inline-flex;align-items:center;width:3.25rem;height:1.75rem;border-radius:999px;border:1px solid rgba(255,255,255,.1);background:rgba(24,24,27,.9)}
    .switch.light{border-color:rgba(0,0,0,.12);background:rgba(255,255,255,.85)}
    .switch__knob{position:absolute;top:0.125rem;left:0.125rem;height:1.5rem;width:1.5rem;border-radius:999px;background:#fff;transform:translateX(0);transition:transform .2s ease}
    .switch--on .switch__knob{transform:translateX(1.5rem)}
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="sticky top-0 z-50 glass" data-glass role="banner">
    <div class="mx-auto flex max-w-7xl items-center gap-3 px-4 py-3">
      <a href="#" class="text-xl font-extrabold tracking-tight" aria-label="Aikoshi anasayfa" style="background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent">Aikoshi</a>
      <div class="flex-1"></div>

      <!-- Tema değiştirici -->
      <label class="switch" id="themeSwitch" aria-label="Tema değiştir">
        <input type="checkbox" id="themeToggle" class="sr-only" />
        <span class="switch__knob"></span>
      </label>

      <!-- Search -->
      <div class="relative hidden w-full max-w-md md:block" role="search">
        <i class="fa-solid fa-magnifying-glass pointer-events-none absolute left-3 top-3 text-sm text-zinc-400"></i>
        <input id="search" class="w-full pl-9 pr-3 h-10 rounded-md border border-zinc-700 bg-zinc-900 text-sm text-white placeholder-zinc-400" placeholder="Arama: başlık, tür, etiket…" autocomplete="off" />
      </div>

      <!-- 18+ -->
      <button id="toggle18" class="inline-flex items-center gap-2 rounded-full border border-zinc-700 bg-zinc-800 px-3 py-1.5 text-xs text-white" aria-pressed="false" aria-label="18+ modu">
        <span id="toggleKnob" class="h-5 w-9 rounded-full bg-zinc-700 relative"><span class="absolute top-0.5 left-0.5 h-4 w-4 rounded-full bg-white transition-transform"></span></span>
        <span>18+</span>
      </button>

      <!-- Koleksiyon butonu -->
      <div class="relative">
        <button id="collectionBtn" class="w-10 h-10 rounded-full border border-zinc-700 bg-zinc-800 grid place-items-center text-white" aria-haspopup="menu" aria-expanded="false">
          <i class="fa-solid fa-bookmark"></i>
        </button>
        <div id="collectionMenu" class="hidden absolute right-0 top-full mt-2 w-56 rounded-2xl border border-zinc-700 bg-zinc-900 p-2 shadow-2xl" role="menu" aria-label="Koleksiyonlar">
          <button class="flex w-full items-center gap-2 rounded-lg p-2 hover:bg-zinc-800" role="menuitem" data-list="favorites"><i class="fa-solid fa-heart text-rose-500"></i> Favorilerim</button>
          <button class="flex w-full items-center gap-2 rounded-lg p-2 hover:bg-zinc-800" role="menuitem" data-list="watchlist"><i class="fa-solid fa-clock text-blue-500"></i> İzleme Listesi</button>
          <button class="flex w-full items-center gap-2 rounded-lg p-2 hover:bg-zinc-800" role="menuitem" data-list="completed"><i class="fa-solid fa-check-circle text-emerald-500"></i> Tamamlananlar</button>
          <button class="flex w-full items-center gap-2 rounded-lg p-2 hover:bg-zinc-800" role="menuitem" data-list="custom"><i class="fa-solid fa-plus text-purple-500"></i> Yeni Liste</button>
        </div>
      </div>

      <!-- Kullanıcı butonu -->
      <button id="userBtn" class="w-10 h-10 rounded-full border border-zinc-700 bg-zinc-800 grid place-items-center text-white" aria-controls="userPanel" aria-expanded="false"><i class="fa-solid fa-user"></i></button>

      <!-- Mobile search -->
      <button id="openSearch" class="md:hidden w-10 h-10 rounded-full border border-zinc-700 bg-zinc-800 grid place-items-center text-white" aria-controls="mobileSearchBar" aria-expanded="false">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>
    </div>
  </header>

  <!-- Adult Banner -->
  <div id="adultBanner" class="hidden bg-rose-600/10 text-rose-200 border-y border-rose-600/20" role="status">
    <div class="mx-auto max-w-7xl px-4 py-2 text-sm flex items-center justify-between">
      <span><i class="fa-solid fa-shield-heart mr-2"></i> Yalnızca 18+ içerikler gösteriliyor. <span class="opacity-75 ml-2">(Hızlı çıkış: <kbd>B</kbd>)</span></span>
      <button id="adultBannerClear" class="underline">Kapat</button>
    </div>
  </div>

  <!-- Mobile Search -->
  <div id="mobileSearchBar" class="hidden border-b border-white/10 bg-zinc-900/80 px-4 py-3 md:hidden" role="search">
    <div class="relative">
      <i class="fa-solid fa-magnifying-glass pointer-events-none absolute left-3 top-3 text-sm text-zinc-400"></i>
      <input id="searchMobile" class="w-full pl-9 pr-3 h-10 rounded-md border border-zinc-700 bg-zinc-900 text-sm text-white placeholder-zinc-400" placeholder="Ara…" autocomplete="off" />
    </div>
  </div>

  <!-- AGE GATE -->
  <div id="ageGate" class="fixed inset-0 z-50 hidden place-items-center bg-black/80 p-4 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="ageTitle">
    <div class="w-full max-w-lg rounded-2xl border border-rose-500/30 bg-zinc-900 p-6 shadow-2xl">
      <div class="mb-4 flex items-start gap-3">
        <i class="fa-solid fa-triangle-exclamation text-rose-400 text-2xl"></i>
        <div>
          <h2 id="ageTitle" class="text-xl font-semibold">18+ İçerik Uyarısı</h2>
          <p class="text-zinc-400 mt-1">Bu bölüm yetişkinlere uygun içerik barındırabilir. Devam etmeden önce 18 yaşından büyük olduğunuzu onaylayın.</p>
        </div>
      </div>
      <label class="flex items-center gap-2 text-sm text-zinc-400 mb-3">
        <input id="rememberAdult" type="checkbox" class="accent-rose-500">
        <span>Bu cihazda 24 saat hatırla</span>
      </label>
      <div class="mt-4 flex justify-end gap-3">
        <button id="cancel18" class="rounded-xl border border-zinc-700 bg-zinc-800 px-4 py-2">Vazgeç</button>
        <button id="accept18" class="rounded-xl bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-4 py-2 font-semibold">18+ Onaylıyorum</button>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <section class="hero border-b border-white/5" data-hero aria-labelledby="heroTitle">
    <div class="mx-auto grid max-w-7xl gap-8 px-4 py-12 md:grid-cols-2 md:py-16">
      <div class="space-y-5">
        <h1 id="heroTitle" class="text-4xl md:text-5xl font-extrabold tracking-tight text-white">Anime ve Manga Evreni</h1>
        <p class="text-white/80">Favori animelerini izle, mangalarını oku. Akıllı arama, filtreler ve kişiselleştirilmiş listeler.</p>
        <div class="flex gap-3 pt-2">
          <a id="btnExplore" href="#list" class="rounded-xl bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-4 py-2 font-semibold text-white inline-flex items-center"><i class="fa-solid fa-compass mr-2"></i> Keşfet</a>
          <button id="openFilters" class="rounded-xl border border-zinc-700 bg-zinc-800 px-4 py-2 text-white inline-flex items-center"><i class="fa-solid fa-filter mr-2"></i> Filtreler</button>
        </div>
        <div class="pt-4">
          <h3 class="text-sm font-semibold text-zinc-400 mb-2">TREND TÜRLER</h3>
          <div class="flex flex-wrap gap-2" id="trendTags"></div>
        </div>
      </div>
      <div id="heroManga" class="relative grid grid-cols-1 gap-4 md:grid-cols-2"></div>
    </div>
  </section>

  <!-- FİLTRE BAR -->
  <section class="sticky top-[61px] z-30 border-b border-white/10 glass" data-glass aria-label="Filtre barı">
    <div class="mx-auto flex max-w-7xl flex-wrap items-center gap-3 px-4 py-3 text-sm">
      <div class="flex items-center gap-2">
        <label for="filterType" class="text-zinc-400"><i class="fa-solid fa-tag mr-1"></i> Tür</label>
        <select id="filterType" class="h-9 rounded-md border border-zinc-700 bg-zinc-900 px-2 text-white">
          <option value="all">Hepsi</option>
          <option value="anime">Anime</option>
          <option value="manga">Manga</option>
          <option value="18+">18+</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <label for="sort" class="text-zinc-400"><i class="fa-solid fa-arrow-down-wide-short mr-1"></i> Sırala</label>
        <select id="sort" class="h-9 rounded-md border border-zinc-700 bg-zinc-900 px-2 text-white">
          <option value="new">Yeniden Eskiye</option>
          <option value="pop">Popüler</option>
          <option value="a2z">A→Z</option>
          <option value="z2a">Z→A</option>
          <option value="old">Eskiden Yeniye</option>
          <option value="rating">Yüksek Puan</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <label for="filterRating" class="text-zinc-400"><i class="fa-solid fa-star mr-1"></i> Puan</label>
        <select id="filterRating" class="h-9 rounded-md border border-zinc-700 bg-zinc-900 px-2 text-white">
          <option value="0">Tüm Puanlar</option>
          <option value="9">9+</option>
          <option value="8">8+</option>
          <option value="7">7+</option>
          <option value="6">6+</option>
        </select>
      </div>
      <div class="ml-auto hidden md:block text-xs text-zinc-400" id="countInfo">0 başlık</div>
    </div>
  </section>

  <!-- FİLTRE SHEET -->
  <div id="filtersSheet" class="fixed inset-0 z-50 hidden place-items-end md:place-items-center bg-black/60 p-4 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="filtersTitle">
    <div id="filtersPanel" class="w-full max-w-xl rounded-2xl border border-white/10 bg-zinc-900 p-6 shadow-2xl">
      <div class="mb-5 flex items-center justify-between">
        <h3 id="filtersTitle" class="text-lg font-semibold"><i class="fa-solid fa-filter mr-2 text-purple-400"></i> Filtreler</h3>
        <button id="closeFilters" class="rounded-full bg-zinc-800 p-2 hover:bg-zinc-700" aria-label="Kapat"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="grid gap-5 sm:grid-cols-2">
        <div>
          <label class="text-zinc-400 text-sm"><i class="fa-solid fa-tags mr-2"></i> Etiketler</label>
          <div id="tagCloud" class="mt-2 flex flex-wrap gap-2"></div>
        </div>
        <div>
          <label class="text-zinc-400 text-sm"><i class="fa-solid fa-film mr-2"></i> İçerik Tipi</label>
          <div class="mt-2 flex gap-2" id="typeBtns"></div>
        </div>
        <div>
          <label class="text-zinc-400 text-sm"><i class="fa-solid fa-star mr-2"></i> Minimum Puan</label>
          <div class="mt-2 flex items-center gap-2">
            <input type="range" min="0" max="10" value="0" class="w-full" id="ratingRange" aria-label="Minimum puan" />
            <span id="ratingValue" class="text-sm w-10 text-center">0</span>
          </div>
        </div>
        <div>
          <label class="text-zinc-400 text-sm"><i class="fa-solid fa-calendar mr-2"></i> Yıl Aralığı</label>
          <div class="mt-2 flex gap-2 items-center">
            <input type="number" placeholder="Başlangıç" min="1990" max="2030" class="w-24 h-9 rounded-md border border-zinc-700 bg-zinc-900 px-2 text-sm text-white" id="yearStart" />
            <span class="text-zinc-500">—</span>
            <input type="number" placeholder="Bitiş" min="1990" max="2030" class="w-24 h-9 rounded-md border border-zinc-700 bg-zinc-900 px-2 text-sm text-white" id="yearEnd" />
          </div>
        </div>
      </div>
      <div class="mt-6 flex justify-end gap-3">
        <button id="resetFilters" class="rounded-xl border border-zinc-700 bg-zinc-800 px-4 py-2">Sıfırla</button>
        <button id="applyFilters" class="rounded-xl bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-4 py-2 font-semibold">Uygula</button>
      </div>
    </div>
  </div>

  <!-- LİSTE -->
  <main id="list" class="mx-auto max-w-7xl px-4 py-8 flex-1" aria-live="polite">
    <div id="loadingIndicator" class="hidden flex-col items-center justify-center py-10">
      <div class="skeleton h-6 w-32 mb-4"></div>
      <div class="grid grid-cols-2 gap-5 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6">
        <div class="card">
          <div class="relative aspect-[2/3] w-full overflow-hidden rounded-xl bg-gradient-to-br from-zinc-800 to-zinc-900">
            <div class="skeleton h-full w-full"></div>
          </div>
          <div class="px-0.5 mt-2">
            <div class="skeleton h-4 w-full mb-2"></div>
            <div class="skeleton h-3 w-3/4"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="grid" class="grid grid-cols-2 gap-5 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6"></div>

    <nav id="pagination" class="mt-10 flex items-center justify-center gap-2 flex-wrap" aria-label="Sayfalandırma">
      <button id="prevPage" class="rounded-xl border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm">« Önceki</button>
      <div id="pageList" class="flex gap-1"></div>
      <button id="nextPage" class="rounded-xl border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm">Sonraki »</button>
    </nav>
  </main>

  <!-- DETAY MODAL -->
  <div id="details" class="fixed inset-0 z-50 hidden place-items-center bg-black/80 p-4 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
    <div class="relative w-full max-w-4xl overflow-hidden rounded-2xl border border-white/10 bg-zinc-900 shadow-2xl max-h-[90vh]">
      <button id="closeDetails" class="absolute right-4 top-4 z-10 rounded-full bg-black/70 p-2.5 text-zinc-200 hover:bg-black/90" aria-label="Kapat"><i class="fa-solid fa-xmark"></i></button>
      <div class="grid gap-0 md:grid-cols-2">
        <div class="relative aspect-[2/3]">
          <img id="dImage" class="absolute inset-0 h-full w-full object-cover" alt="Poster" loading="lazy" />
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20"></div>
          <div class="absolute bottom-4 left-4 flex items-center gap-2">
            <span id="dScore" class="badge badge-score"></span>
            <span id="dEpisodes" class="badge"></span>
          </div>
          <div id="dBadges" class="absolute top-4 left-4 flex flex-col gap-1"></div>
          <button id="addToCollection" class="absolute top-4 right-4 rounded-full bg-black/70 p-2.5 text-zinc-200 hover:bg-black/90" aria-haspopup="menu" aria-expanded="false"><i class="fa-solid fa-bookmark"></i></button>
        </div>
        <div class="space-y-5 p-6 overflow-y-auto">
          <h3 id="dTitle" class="text-2xl font-bold"></h3>

          <!-- Kullanıcı puanı (sadece UI) -->
          <div class="flex items-center gap-3" aria-label="Puan ver">
            <div class="flex gap-1" id="starWrap" aria-hidden="false"></div>
            <span class="text-sm text-zinc-400">Puan ver</span>
          </div>

          <p id="dSynopsis" class="text-zinc-300 leading-relaxed"></p>
          <div id="dTags" class="flex flex-wrap gap-2"></div>
          <div class="flex gap-3 pt-3">
            <a id="btnPlay" target="_blank" rel="noopener" class="rounded-xl bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-4 py-2 font-semibold inline-flex items-center text-white"><i class="fa-solid fa-play mr-2"></i> İzle/Oku</a>
            <button class="rounded-xl border border-zinc-700 bg-zinc-800 px-4 py-2">Listeye Ekle</button>
          </div>
          <div class="pt-5">
            <h4 class="mb-3 text-lg font-semibold"><i class="fa-solid fa-list mr-2 text-purple-400"></i> Bölümler</h4>
            <div id="dEpisodesList" class="max-h-60 space-y-2 overflow-y-auto rounded-xl border border-zinc-800 p-4 bg-zinc-900/50"></div>
          </div>

          <!-- Yorumlar (demo) -->
          <div class="mt-4">
            <h4 class="mb-3 text-lg font-semibold"><i class="fa-solid fa-comments mr-2 text-purple-400"></i> Yorumlar</h4>
            <div class="mb-4">
              <label class="visually-hidden" for="commentBox">Yorumunuzu yazın</label>
              <textarea id="commentBox" placeholder="Yorumunuzu yazın..." class="w-full rounded-lg border border-zinc-700 bg-zinc-900 p-3 text-sm text-white" rows="3"></textarea>
              <button id="commentBtn" class="mt-2 rounded-xl bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-4 py-2 text-sm font-semibold">Yorum Yap</button>
            </div>
            <div id="commentsContainer"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KULLANICI PANELI -->
  <aside id="userPanel" class="fixed inset-y-0 right-0 z-50 w-80 bg-zinc-900 shadow-xl translate-x-full transition-transform duration-300" role="dialog" aria-modal="true" aria-labelledby="userTitle">
    <div class="p-5 border-b border-zinc-800">
      <div class="flex items-center justify-between">
        <h3 id="userTitle" class="font-semibold">Profilim</h3>
        <button id="closeUserPanel" class="text-zinc-400" aria-label="Kapat"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
    <div class="p-5">
      <div class="flex items-center gap-3 mb-5">
        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-pink-500"></div>
        <div>
          <h4 class="font-semibold">Misafir Kullanıcı</h4>
          <p class="text-sm text-zinc-400">0 puan</p>
        </div>
      </div>
      <div class="mb-5">
        <h5 class="text-sm font-semibold mb-2">Listelerim</h5>
        <div class="space-y-2">
          <a href="#" class="flex items-center justify-between p-2 rounded-lg hover:bg-zinc-800"><span class="text-sm">Favorilerim</span><span class="text-xs bg-purple-500 text-white rounded-full px-2 py-1">0</span></a>
          <a href="#" class="flex items-center justify-between p-2 rounded-lg hover:bg-zinc-800"><span class="text-sm">İzleme Listesi</span><span class="text-xs bg-blue-500 text-white rounded-full px-2 py-1">0</span></a>
          <a href="#" class="flex items-center justify-between p-2 rounded-lg hover:bg-zinc-800"><span class="text-sm">Tamamlananlar</span><span class="text-xs bg-emerald-500 text-white rounded-full px-2 py-1">0</span></a>
        </div>
      </div>
      <button id="openLogin" class="w-full rounded-xl border border-zinc-700 bg-zinc-800 px-4 py-2">Giriş Yap</button>
    </div>
  </aside>

  <!-- AUTH (Giriş / Kayıt) MODAL -->
  <div id="authModal" class="fixed inset-0 z-50 hidden place-items-center bg-black/80 backdrop-blur-sm">
    <div class="w-full max-w-md rounded-2xl border border-zinc-700 bg-zinc-900 p-6 shadow-2xl">
      <h2 id="authTitle" class="text-xl font-bold mb-4">Giriş Yap</h2>
      <input id="authEmail" type="email" placeholder="E-posta" class="w-full mb-3 rounded-lg border border-zinc-700 bg-zinc-800 p-2 text-white"/>
      <input id="authPass" type="password" placeholder="Şifre" class="w-full mb-3 rounded-lg border border-zinc-700 bg-zinc-800 p-2 text-white"/>
      <input id="authUser" type="text" placeholder="Kullanıcı adı (Kayıt)" class="w-full mb-3 hidden rounded-lg border border-zinc-700 bg-zinc-800 p-2 text-white"/>
      <div id="authError" class="text-rose-400 text-sm mb-3 hidden"></div>
      <div class="flex justify-between items-center gap-3">
        <button id="switchAuth" class="text-sm underline">Kayıt Ol</button>
        <div class="flex gap-2">
          <button id="authSubmit" class="rounded-lg bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] px-4 py-2 font-semibold">Giriş Yap</button>
          <button id="closeAuth" class="rounded-lg border border-zinc-700 bg-zinc-800 px-4 py-2">Kapat</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="mt-12 border-t border-white/10 bg-zinc-900">
    <div class="mx-auto max-w-7xl px-4 py-6 text-sm text-zinc-400">
      <p>© <span id="year"></span> Aikoshi. Bu arayüz demodur.</p>
    </div>
  </footer>

  <script>
  // ====== Constants & Helpers ======
  const TZ_TR = "Europe/Istanbul";
  const STORAGE_KEY = "aikoshi-ui";
  const ADULT_KEY = "aikoshi-adult";
  const THEME_KEY = "aikoshi-theme";
  const PAGE_SIZE = 18;

  const $ = (s,sc=document)=>sc.querySelector(s);
  const $$ = (s,sc=document)=>[...sc.querySelectorAll(s)];
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
  const ts = (iso)=> { const t=Date.parse(iso||""); return Number.isFinite(t)?t:0 };
  const fmt = new Intl.DateTimeFormat('tr-TR',{ dateStyle:'medium', timeZone: TZ_TR });

  // ====== Demo Data (replace with real) ======
  const DATA_SFW = [
    { id:1,  title:"Steel Gear: Akuma Protocol", image:"img/steel-gear.jpg", episodes:12, sub:true,  dub:false, type:"anime", tags:["Action","Sci-Fi","Cyberpunk"], score:8.7, synopsis:"MegaTokyo'da kirli bir komployu açığa çıkaran cyborg ajan.", createdAt:"2025-08-20T00:00:00+03:00" },
    { id:3,  title:"Samurai of the Neon Rain",   image:"img/neon-rain.jpg",   episodes:24, sub:true,  dub:false, type:"anime", tags:["Samurai","Noir","Thriller"], score:8.2, synopsis:"Yağmurun dinmediği şehirde onuru peşinde bir ronin.", createdAt:"2025-08-19T00:00:00+03:00" },
    { id:4,  title:"Crimson Alchemist: Ouroboros",image:"img/alchemist.jpg",  episodes:13, sub:true,  dub:true,  type:"anime", tags:["Fantasy","Mystery"], score:8.6, synopsis:"Yasak simyanın izinde kadim büyüler.", createdAt:"2025-08-18T00:00:00+03:00" },
    { id:6,  title:"Neon Drifters: Night Circuit",image:"img/drifters.jpg",   episodes:10, sub:true,  dub:false, type:"anime", tags:["Racing","Action"], score:7.9, synopsis:"Neon ışıklar altında yasa dışı yarışlar.", createdAt:"2025-08-05T00:00:00+03:00" },
    { id:7,  title:"Arcadia Echoes",              image:"img/arcadia.jpg",   episodes:22, sub:true,  dub:true,  type:"anime", tags:["Adventure","Drama"], score:8.1, synopsis:"Kaybolan uygarlığın yankıları.", createdAt:"2025-05-26T00:00:00+03:00" },
    { id:8,  title:"Moonlit Labyrinth",           image:"img/labyrinth.jpg", episodes:9,  sub:true,  dub:false, type:"anime", tags:["Mystery","Psychological"], score:8.3, synopsis:"Düş ile gerçek arasında bir labirent.", createdAt:"2025-08-20T00:00:00+03:00" },
    { id:10, title:"Kizuna: Sonsuz Bağ",          image:"img/kizuna.jpg",    episodes:15, sub:false, dub:false, type:"manga", tags:["Romance","Slice of Life","Drama"], score:8.8, synopsis:"Yolları kesişen iki dünya.", links:Array.from({length:15},(_,i)=>`https://ex.com/kizuna/${i+1}`), createdAt:"2025-08-25T00:00:00+03:00" },
    { id:11, title:"Cyber Rebellion",             image:"img/cyber-rebel.jpg",episodes:16,sub:true,  dub:true,  type:"anime", tags:["Action","Sci-Fi","Cyberpunk"], score:8.5, synopsis:"Genç hacker'ların özgürlük savaşı.", createdAt:"2025-08-24T00:00:00+03:00" },
    { id:12, title:"Sakura Dreams",               image:"img/sakura.jpg",   episodes:12, sub:true,  dub:false, type:"anime", tags:["Romance","Slice of Life","Drama"], score:8.2, synopsis:"Kiraz çiçekleriyle gelen aşk.", createdAt:"2025-08-23T00:00:00+03:00" },
    { id:14, title:"Ocean Whisper",               image:"img/ocean.jpg",    episodes:10, sub:true,  dub:false, type:"anime", tags:["Adventure","Fantasy","Mystery"], score:8.0, synopsis:"Derinliklerdeki gizemli dünya.", createdAt:"2025-08-22T00:00:00+03:00" },
    { id:15, title:"Eternal Winter",              image:"img/winter.jpg",   episodes:14, sub:true,  dub:true,  type:"anime", tags:["Fantasy","Adventure","Drama"], score:8.4, synopsis:"Sonsuz kışta umut arayışı.", createdAt:"2025-08-21T00:00:00+03:00" },
    { id:17, title:"Starlight Symphony",          image:"img/starlight.jpg",episodes:12, sub:true,  dub:true,  type:"anime", tags:["Music","Drama","Romance"], score:8.1, synopsis:"Müzikle değişen hayatlar.", createdAt:"2025-08-17T00:00:00+03:00" },
    { id:18, title:"Phoenix Rising",              image:"img/phoenix.jpg",  episodes:24, sub:true,  dub:false, type:"anime", tags:["Action","Fantasy","Adventure"], score:8.6, synopsis:"Efsanevi güce sahip savaşçı.", createdAt:"2025-08-16T00:00:00+03:00" },
    { id:20, title:"Silent Echo",                 image:"img/silent-echo.jpg",episodes:10,sub:false,dub:false, type:"manga", tags:["Mystery","Psychological","Drama"], score:8.5, synopsis:"Geçmişin yankılarının peşinde bir dedektif.", links:Array.from({length:10},(_,i)=>`https://ex.com/silent/${i+1}`), createdAt:"2025-08-15T00:00:00+03:00" }
  ];
  const DATA_ADULT = [
    { id:2,  title:"Midnight Shrine – Forbidden Petals", image:"img/midnight-shrine.jpg", episodes:8, sub:true, dub:true, type:"anime", tags:["Romance","Drama","18+"], score:8.4, synopsis:"Gece tapınağında kesişen yollar.", createdAt:"2025-08-14T00:00:00+03:00" },
    { id:5,  title:"Velvet Chains – Scarlet Nights",      image:"img/velvet-chains.jpg",  episodes:6, sub:true, dub:false,type:"anime", tags:["18+","Romance","Mature"], score:8.0, synopsis:"Koyu sırların ördüğü ilişkiler.", createdAt:"2025-08-13T00:00:00+03:00" },
    { id:9,  title:"31'ci Orkun",                         image:"img/31ci-orkun.jpg",     episodes:9, sub:true, dub:false,type:"manga", tags:["Mystery","Psychological","18+","Mature"], score:8.3, synopsis:"Düş ile gerçeklik arasında kayboluş.", links:Array.from({length:9},(_,i)=>`https://ex.com/31/${i+1}`), createdAt:"2025-08-12T00:00:00+03:00" },
    { id:13, title:"Demon's Heart",                       image:"img/demons-heart.jpg",   episodes:20,sub:true,dub:true, type:"anime", tags:["Action","Fantasy","18+"], score:8.7, synopsis:"İnsan ve iblis dünyaları arasında bir kader.", createdAt:"2025-08-11T00:00:00+03:00" },
    { id:16, title:"Shadow Games",                        image:"img/shadow-games.jpg",   episodes:8, sub:true, dub:false,type:"anime", tags:["Psychological","Thriller","18+"], score:8.3, synopsis:"Zihin oyunları ve ölümcül sırlar.", createdAt:"2025-08-10T00:00:00+03:00" },
    { id:19, title:"Crimson Moon",                        image:"img/crimson-moon.jpg",   episodes:13,sub:true,dub:true, type:"manga", tags:["Supernatural","Horror","18+"], score:8.2, synopsis:"Kızıl ayın altındaki sırlar.", links:Array.from({length:13},(_,i)=>`https://ex.com/crimson/${i+1}`), createdAt:"2025-08-25T00:00:00+03:00" }
  ];

  // ====== App State ======
  let state = {
    page:1, perPage:PAGE_SIZE,
    query:"", type:"all", sort:"new", minRating:0, yearStart:0, yearEnd:0,
    only18:false, tags:new Set(), selected:null,
    theme: localStorage.getItem(THEME_KEY) || 'dark',
    collections: JSON.parse(localStorage.getItem("aikoshi-collections") || '{"favorites":[],"watchlist":[],"completed":[]}')
  };

  // ====== Elements ======
  const grid   = $("#grid");
  const search = $("#search");
  const searchMobile = $("#searchMobile");
  const openSearchBtn = $("#openSearch");
  const filterType = $("#filterType");
  const sortSel = $("#sort");
  const filterRating = $("#filterRating");
  const ratingRange = $("#ratingRange");
  const ratingValue = $("#ratingValue");
  const yearStart = $("#yearStart");
  const yearEnd = $("#yearEnd");
  const countInfo = $("#countInfo");
  const btnExplore = $("#btnExplore");
  const openFilters = $("#openFilters");
  const closeFilters = $("#closeFilters");
  const filtersSheet = $("#filtersSheet");
  const tagCloud = $("#tagCloud");
  const typeBtns = $("#typeBtns");
  const details = $("#details");
  const dImage=$("#dImage"), dTitle=$("#dTitle"), dScore=$("#dScore"), dEpisodes=$("#dEpisodes"), dBadges=$("#dBadges"), dSynopsis=$("#dSynopsis"), dTags=$("#dTags"), dEpisodesList=$("#dEpisodesList"), btnPlay=$("#btnPlay");
  const ageGate=$("#ageGate"), toggle18=$("#toggle18"), toggleKnob=$("#toggleKnob"), accept18=$("#accept18"), cancel18=$("#cancel18"), rememberAdult=$("#rememberAdult");
  const adultBanner=$("#adultBanner"), adultBannerClear=$("#adultBannerClear");
  const prevPageBtn=$("#prevPage"), nextPageBtn=$("#nextPage"), pageList=$("#pageList");
  const themeToggle = $("#themeToggle");
  const themeSwitch = $("#themeSwitch");
  const collectionBtn = $("#collectionBtn");
  const collectionMenu = $("#collectionMenu");
  const userBtn = $("#userBtn");
  const userPanel = $("#userPanel");
  const closeUserPanel = $("#closeUserPanel");
  const addToCollection = $("#addToCollection");
  const loadingIndicator = $("#loadingIndicator");
  const commentsContainer = $("#commentsContainer");
  const commentBtn = $("#commentBtn");
  const starWrap = $("#starWrap");

  // ====== Auth Elements ======
  const openLogin = $("#openLogin");
  const authModal = $("#authModal");
  const authTitle = $("#authTitle");
  const authEmail = $("#authEmail");
  const authPass  = $("#authPass");
  const authUser  = $("#authUser");
  const authError = $("#authError");
  const authSubmit= $("#authSubmit");
  const switchAuth= $("#switchAuth");
  const closeAuth = $("#closeAuth");

  // ====== Utils ======
  function pool(){ return state.only18 ? DATA_ADULT.map(x=>({...x,__adult:true})) : DATA_SFW.map(x=>({...x,__adult:false})) }
  function findById(id){
    let s=DATA_SFW.find(d=>d.id==id); if(s) return {...s,__adult:false};
    let a=DATA_ADULT.find(d=>d.id==id); if(a) return {...a,__adult:true};
    return null;
  }
  function saveUIState(){
    const s={page:state.page,perPage:state.perPage,query:state.query,type:state.type,sort:state.sort,minRating:state.minRating,yearStart:state.yearStart,yearEnd:state.yearEnd,only18:state.only18,tags:[...state.tags]};
    localStorage.setItem(STORAGE_KEY,JSON.stringify(s));
  }
  function loadUIState(){
    try{ const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
      state.page=s.page||1; state.query=s.query||""; state.type=s.type||"all"; state.sort=s.sort||"new"; state.minRating=s.minRating||0; state.yearStart=s.yearStart||0; state.yearEnd=s.yearEnd||0; state.only18=!!s.only18; state.tags=new Set(s.tags||[]);
    }catch{}
  }
  function setAdultConsent(hours=24){ localStorage.setItem(ADULT_KEY,JSON.stringify({ok:true,expiresAt:Date.now()+hours*3600*1000})) }
  function getAdultConsent(){ try{const v=JSON.parse(localStorage.getItem(ADULT_KEY)||"{}"); return v.ok && v.expiresAt && Date.now()<v.expiresAt }catch{return false} }
  function setTheme(theme){
    state.theme = theme;
    localStorage.setItem(THEME_KEY, theme);
    const root = document.documentElement;
    const hero = document.querySelector('[data-hero]');
    // Tailwind dark class
    if (theme === 'light') {
      root.classList.remove('dark');
      root.classList.add('light-mode');
      themeToggle.checked = true;
      themeSwitch.classList.add('switch','light','switch--on');
      // swap glass surfaces
      $$('[data-glass]').forEach(el=>{ el.classList.remove('glass'); el.classList.add('glass-light'); });
      // hero bg
      hero.classList.remove('hero'); hero.classList.add('hero-light');
    } else {
      root.classList.add('dark');
      root.classList.remove('light-mode');
      themeToggle.checked = false;
      themeSwitch.classList.add('switch');
      themeSwitch.classList.remove('light','switch--on');
      $$('[data-glass]').forEach(el=>{ el.classList.add('glass'); el.classList.remove('glass-light'); });
      hero.classList.add('hero'); hero.classList.remove('hero-light');
    }
  }

  function makeBadge(text, cls=""){
    const s=document.createElement("span");
    s.className= state.theme==='light' ? `badge-light ${cls}` : `badge ${cls}`;
    s.textContent=text; return s;
  }

  // star rating (UI only)
  function renderStars(){
    starWrap.innerHTML='';
    for(let i=1;i<=5;i++){
      const b=document.createElement('button');
      b.className='h-6 w-6 grid place-items-center';
      b.innerHTML = `<i class="fa-star ${i<=3?'fa-solid':'fa-regular'}"></i>`;
      b.title = `${i} yıldız`;
      b.addEventListener('click',()=>{
        [...starWrap.children].forEach((c,idx)=>{ c.innerHTML = `<i class=\"fa-star ${idx<i?'fa-solid':'fa-regular'}\"></i>` })
      });
      starWrap.appendChild(b);
    }
  }

  // ====== Auth Functions ======
  function getUsers(){ return JSON.parse(localStorage.getItem("aikoshi-users")||"[]"); }
  function saveUsers(arr){ localStorage.setItem("aikoshi-users", JSON.stringify(arr)); }
  function getCurrentUser(){ return JSON.parse(localStorage.getItem("aikoshi-current")||"null"); }
  function setCurrentUser(u){ localStorage.setItem("aikoshi-current", JSON.stringify(u)); }

  let isRegister = false;

  function openAuth(register=false){
    isRegister = register;
    authTitle.textContent = register ? "Kayıt Ol" : "Giriş Yap";
    authUser.classList.toggle("hidden", !register);
    authError.classList.add("hidden");
    authEmail.value = ""; authPass.value = ""; authUser.value = "";
    authModal.classList.remove("hidden");
  }
  function closeAuthModal(){ authModal.classList.add("hidden"); }
  function updateProfile(){
    const u = getCurrentUser();
    if(!u) {
      $("#userTitle").textContent = "Profilim";
      $("#userPanel .mb-5 h4").textContent = "Misafir Kullanıcı";
      $("#userPanel .mb-5 p").textContent  = "0 puan";
      openLogin.textContent = "Giriş Yap";
      return;
    }
    $("#userTitle").textContent = u.username;
    $("#userPanel .mb-5 h4").textContent = u.username;
    $("#userPanel .mb-5 p").textContent  = u.email;
    openLogin.textContent = "Çıkış Yap";
  }

  // ====== Renderers ======
  function createCard(item){
    const btn=document.createElement("button");
    btn.className="card text-left group";
    btn.setAttribute('aria-label', item.title);
    btn.innerHTML=`
      <div class="relative">
        <div class="relative aspect-[2/3] w-full overflow-hidden rounded-xl bg-gradient-to-br from-zinc-800 to-zinc-900 ring-1 ring-zinc-800">
          <img alt="${item.title}" class="absolute inset-0 h-full w-full object-cover transition-transform group-hover:scale-105" src="${item.image}" loading="lazy" onerror="this.src='data:image/svg+xml,${encodeURIComponent('<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'600\'><rect width=\'100%\' height=\'100%\' fill=\'#111827\'/><text x=\'50%\' y=\'50%\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'#9ca3af\' font-size=\'20\'>Poster yok</text></svg>')}'" />
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/10"></div>
          <div class="absolute left-2 top-2 z-10 flex flex-col gap-1">
            ${item.__adult? '<span class="badge badge-18">18+</span>' : ''}
            ${Date.now()-ts(item.createdAt)<1000*60*60*24*30? '<span class="badge">Yeni</span>' : ''}
          </div>
          <div class="absolute bottom-2 right-2 z-10"><span class="badge badge-score">${item.score}</span></div>
        </div>
        <div class="px-0.5 mt-2">
          <h3 class="line-clamp-1 text-sm font-semibold">${item.title}</h3>
          <p class="line-clamp-2 text-xs text-zinc-400 mt-1">${item.synopsis}</p>
          <div class="mt-2 flex flex-wrap gap-1.5">${item.tags.slice(0,3).map(t=>makeBadge(t).outerHTML).join("")}</div>
        </div>
      </div>`;
    btn.addEventListener("click",()=>openDetails(item));
    return btn;
  }

  function renderHeroManga(){
    const items = pool().filter(x=>x.type==="manga").sort((a,b)=>ts(b.createdAt)-ts(a.createdAt)).slice(0,2);
    const wrap = $("#heroManga"); wrap.innerHTML="";
    items.forEach(it=>{
      const card=document.createElement("button");
      card.className="relative rounded-2xl ring-2 ring-white/10 overflow-hidden card text-left";
      card.innerHTML=`
        <img src="${it.image}" alt="${it.title}" class="h-56 md:h-full w-full object-cover" loading="lazy"/>
        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20"></div>
        <div class="absolute top-3 left-3 flex items-center gap-2">
          ${it.__adult? '<span class="badge badge-18">18+</span>' : ''}
          <span class="badge">Bölüm ${it.episodes}</span>
        </div>
        <div class="absolute bottom-3 left-3 right-3">
          <div class="text-lg font-semibold text-white">${it.title}</div>
          <div class="mt-2 flex flex-wrap gap-1.5">${it.tags.slice(0,3).map(t=>makeBadge(t).outerHTML).join("")}</div>
          <button class="mt-3 rounded-xl border border-zinc-700 bg-zinc-800/70 px-3 py-1.5 text-sm">Detay</button>`;
      card.addEventListener("click",()=>openDetails(it));
      wrap.appendChild(card);
    });
  }

  function renderTrendTags(){
    const tags = Array.from(new Set([...DATA_SFW,...DATA_ADULT].flatMap(d=>d.tags))).sort();
    const wrap = $("#trendTags");
    wrap.innerHTML = tags.slice(0,8).map(t=>`<button data-tag="${t}" class="rounded-full border border-zinc-700 px-3 py-1 text-xs hover:bg-zinc-800">${t}</button>`).join("");
    wrap.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click',()=>{ state.tags.add(b.dataset.tag); state.page=1; render(); saveUIState(); })
    })
  }

  // ====== Details Modal ======
  function openDetails(item){
    if(item.__adult && !state.only18){ state.selected=item; openModal(ageGate,$("#accept18")); return; }
    state.selected=item;
    dImage.src=item.image; dTitle.textContent=item.title; dScore.textContent=String(item.score); dEpisodes.textContent=`${item.episodes} Bölüm`;
    dBadges.innerHTML=(item.__adult?makeBadge("18+","badge-18").outerHTML:"") + (item.type!=="manga" && item.sub?makeBadge("SUB").outerHTML:"") + (item.type!=="manga" && item.dub?makeBadge("DUB").outerHTML:"");
    dSynopsis.textContent=item.synopsis; dTags.innerHTML=item.tags.map(t=>makeBadge(t).outerHTML).join("");

    if(Array.isArray(item.links) && item.links.length){ btnPlay.href=item.links[0]; btnPlay.classList.remove('pointer-events-none','opacity-50'); }
    else { btnPlay.href="#"; btnPlay.classList.add('pointer-events-none','opacity-50'); }

    if(Array.isArray(item.links)&&item.links.length){
      dEpisodesList.innerHTML=item.links.map((href,i)=>`<a href="${href}" target="_blank" rel="noopener" class="flex w-full items-center justify-between rounded-lg bg-zinc-800/60 px-4 py-2.5 text-left text-sm text-purple-300 hover:bg-zinc-700"> <span><i class="fa-solid fa-play-circle mr-2"></i> Bölüm ${i+1}</span><span class="text-xs text-zinc-400">${item.type==='manga'?'Manga':'24 dk'}</span></a>`).join("");
    }else{
      dEpisodesList.innerHTML=Array.from({length:item.episodes}).map((_,i)=>`<button class="flex w-full items-center justify-between rounded-lg bg-zinc-800/60 px-4 py-2.5 text-left text-sm text-zinc-200 hover:bg-zinc-700"><span><i class="fa-solid fa-play-circle mr-2"></i> Bölüm ${i+1}</span><span class="text-xs text-zinc-400">${item.type==='manga'?'Manga':'24 dk'}</span></button>`).join("");
    }
    commentsContainer.innerHTML = `<div class="rounded-lg bg-zinc-800 p-3 text-sm"><span class="font-semibold">AnimeSever42</span> • <span class="text-zinc-400">${fmt.format(new Date())}</span><p class="mt-1">Bu seriyi çok beğendim, karakter gelişimi harika!</p></div>`;

    openModal(details,$("#btnPlay"));
    renderStars();
  }

  function closeModal(el){ el.classList.add("hidden"); document.body.classList.remove("overflow-hidden") }
  function openModal(el,focusEl){ el.classList.remove("hidden"); document.body.classList.add("overflow-hidden"); setTimeout(()=>focusEl?.focus(),0) }

  $("#closeDetails").addEventListener("click",()=>closeModal(details));
  details.addEventListener("click",(e)=>{ if(e.target===details) closeModal(details) });

  // ====== Filters & Search ======
  function renderTagCloud(){
    const ALL = Array.from(new Set([...DATA_SFW,...DATA_ADULT].flatMap(d=>d.tags))).sort();
    tagCloud.innerHTML = ALL.map(t=>`<button data-tag="${t}" class="rounded-lg border border-zinc-700 bg-zinc-900 px-3 py-1.5 text-xs">${t}</button>`).join("");
    tagCloud.querySelectorAll("button").forEach(b=>{
      const t=b.dataset.tag; b.classList.toggle("ring-1",state.tags.has(t));
      b.addEventListener("click",()=>{ state.tags.has(t)?state.tags.delete(t):state.tags.add(t); b.classList.toggle("ring-1"); state.page=1; render(); saveUIState(); });
    });

    // Type buttons
    typeBtns.innerHTML = ['all','anime','manga','18+'].map(t=>`<button data-type="${t}" class="rounded-lg border border-zinc-700 bg-zinc-900 px-3 py-1.5 text-sm ${state.type===t?'ring-2 ring-purple-500':''}">${t.toUpperCase()}</button>`).join('');
    typeBtns.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click',()=>{ state.type=b.dataset.type; renderTagCloud(); state.page=1; render(); saveUIState(); })
    });
  }

  function filterData(){
    let filtered=pool();
    if(state.query){
      const q=state.query.toLowerCase();
      filtered=filtered.filter(i=> i.title.toLowerCase().includes(q) || i.synopsis.toLowerCase().includes(q) || i.tags.some(t=>t.toLowerCase().includes(q)));
    }
    if(state.type==="18+") filtered = filtered.filter(x=>x.__adult===true);
    else if(state.type==="anime"||state.type==="manga") filtered=filtered.filter(x=>x.type===state.type);
    if(state.tags.size){ const must=[...state.tags]; filtered=filtered.filter(i=>must.every(t=>i.tags.includes(t))) }
    if(state.minRating > 0) filtered = filtered.filter(i => i.score >= state.minRating);
    if(state.yearStart > 0 || state.yearEnd > 0) {
      const currentYear = new Date().getFullYear();
      const start = state.yearStart || 1990;
      const end = state.yearEnd || currentYear;
      filtered = filtered.filter(i => { const y=new Date(ts(i.createdAt)).getFullYear(); return y>=start && y<=end; });
    }
    filtered.sort((a,b)=>{
      if(state.sort==="pop"||state.sort==="rating") return b.score-a.score;
      if(state.sort==="a2z") return a.title.localeCompare(b.title);
      if(state.sort==="z2a") return b.title.localeCompare(a.title);
      if(state.sort==="old") return ts(a.createdAt)-ts(b.createdAt);
      return ts(b.createdAt)-ts(a.createdAt);
    });
    return filtered;
  }

  function renderPagination(total){
    const totalPages=Math.max(1,Math.ceil(total/state.perPage));
    state.page=clamp(state.page,1,totalPages);
    pageList.innerHTML="";
    const maxShow=5; let start=Math.max(1,state.page-Math.floor(maxShow/2)); let end=Math.min(totalPages,start+maxShow-1); if(end-start+1<maxShow) start=Math.max(1,end-maxShow+1);
    for(let i=start;i<=end;i++){
      const b=document.createElement("button");
      b.className=`rounded-xl border border-zinc-700 bg-zinc-800 px-3 py-2 text-sm ${i===state.page?'ring-2 ring-purple-500':''}`;
      b.textContent=i; b.addEventListener("click",()=>{state.page=i;render();saveUIState();}); pageList.appendChild(b);
    }
    prevPageBtn.disabled=state.page===1; nextPageBtn.disabled=state.page===totalPages;
  }

  function simulateLoading(){
    loadingIndicator.classList.remove('hidden'); grid.innerHTML='';
    return new Promise(resolve=>{ setTimeout(()=>{ loadingIndicator.classList.add('hidden'); resolve(); }, 300); });
  }

  async function render(){
    await simulateLoading();
    const data=filterData(); const total=data.length; const start=(state.page-1)*state.perPage, end=start+state.perPage; const pageData=data.slice(start,end);
    grid.innerHTML=""; pageData.forEach(it=>grid.appendChild(createCard(it)));
    countInfo.textContent=`${total} başlık`;
    renderPagination(total); renderHeroManga(); updateAdultBanner();
  }

  // ====== Adult Mode ======
  function updateAdultBanner(){ adultBanner.classList.toggle("hidden",!state.only18); }
  toggle18.addEventListener("click",()=>{ if(!state.only18){ openModal(ageGate,accept18); } else { state.only18=false; toggleKnob.firstElementChild.style.transform="translateX(0)"; document.documentElement.classList.remove("adult-mode"); render(); saveUIState(); } });
  accept18.addEventListener("click",()=>{ state.only18=true; if(rememberAdult.checked) setAdultConsent(); toggleKnob.firstElementChild.style.transform="translateX(1.25rem)"; document.documentElement.classList.add("adult-mode"); closeModal(ageGate); render(); saveUIState(); });
  cancel18.addEventListener("click",()=>closeModal(ageGate));
  adultBannerClear.addEventListener("click",()=>{ state.only18=false; document.documentElement.classList.remove("adult-mode"); toggleKnob.firstElementChild.style.transform="translateX(0)"; render(); saveUIState(); });
  document.addEventListener("keydown",(e)=>{ if(e.key.toLowerCase()==='b'&&state.only18){ state.only18=false; document.documentElement.classList.remove("adult-mode"); toggleKnob.firstElementChild.style.transform="translateX(0)"; render(); saveUIState(); }});

  // ====== New / improved interactions ======
  themeToggle.addEventListener('change',()=>{ setTheme(themeToggle.checked ? 'light' : 'dark'); render(); });

  // Koleksiyon menüsü + dışarı tık kapatma
  collectionBtn.addEventListener('click',()=>{ const open = collectionMenu.classList.toggle('hidden'); collectionBtn.setAttribute('aria-expanded', String(!open)); collectionMenu.querySelector('[role=menuitem]')?.focus(); });
  document.addEventListener('click',(e)=>{ if (!collectionBtn.contains(e.target) && !collectionMenu.contains(e.target)) collectionMenu.classList.add('hidden'); });

  // Koleksiyon öğeleri
  $$('#collectionMenu [role=menuitem]').forEach(item=>{
    item.addEventListener('click',()=>{
      const listType = item.dataset.list;
      if (listType === 'custom') {
        const listName = prompt('Liste adı:');
        if (listName) { state.collections[listName] = []; localStorage.setItem("aikoshi-collections", JSON.stringify(state.collections)); alert(`${listName} listesi oluşturuldu!`); }
      } else if (state.selected) {
        if (!state.collections[listType].includes(state.selected.id)) {
          state.collections[listType].push(state.selected.id);
          localStorage.setItem("aikoshi-collections", JSON.stringify(state.collections));
          alert(`${state.selected.title} ${listType} listesine eklendi!`);
        } else { alert('Bu içerik zaten listede!'); }
      } else { alert('Önce bir içerik seçin.'); }
      collectionMenu.classList.add('hidden');
    });
  });

  // Kullanıcı paneli
  userBtn.addEventListener('click',()=>{ 
    const u = getCurrentUser();
    if(u){ 
      userPanel.style.transform='translateX(0)'; 
      userBtn.setAttribute('aria-expanded','true');
    } else { 
      openAuth(false); 
    }
  });
  
  closeUserPanel.addEventListener('click',()=>{ userPanel.style.transform='translateX(100%)'; userBtn.setAttribute('aria-expanded','false') });

  // Puan filtreleme
  filterRating.addEventListener('change',()=>{ state.minRating=parseInt(filterRating.value); state.page=1; render(); saveUIState(); });

  // Range kontrol
  ratingRange.addEventListener('input',()=>{ ratingValue.textContent=ratingRange.value; state.minRating=parseInt(ratingRange.value); state.page=1; render(); saveUIState(); });

  // Yıl filtreleme
  yearStart.addEventListener('change',()=>{ state.yearStart=parseInt(yearStart.value)||0; state.page=1; render(); saveUIState(); });
  yearEnd.addEventListener('change',()=>{ state.yearEnd=parseInt(yearEnd.value)||0; state.page=1; render(); saveUIState(); });

  // Filtre aç/kapat
  openFilters.addEventListener("click",()=>{ renderTagCloud(); openModal(filtersSheet,$("#applyFilters")) });
  closeFilters.addEventListener("click",()=>closeModal(filtersSheet));
  $("#applyFilters").addEventListener("click",()=>{ state.page=1; render(); closeModal(filtersSheet); saveUIState(); });
  $("#resetFilters").addEventListener("click",()=>{ state.tags.clear(); state.type='all'; state.sort='new'; state.minRating=0; state.yearStart=0; state.yearEnd=0; filterType.value='all'; sortSel.value='new'; filterRating.value='0'; ratingRange.value='0'; ratingValue.textContent='0'; yearStart.value=''; yearEnd.value=''; renderTagCloud(); render(); saveUIState(); });

  // Selectler
  filterType.addEventListener("change",()=>{ state.type=filterType.value; state.page=1; render(); saveUIState(); });
  sortSel.addEventListener("change",()=>{ state.sort=sortSel.value; state.page=1; render(); saveUIState(); });

  // Search (debounce)
  const debounce=(fn,ms=150)=>{ let t; return(...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms) } };
  const applyQuery=(v)=>{ state.query=v.toLowerCase(); state.page=1; render(); saveUIState(); };
  search?.addEventListener("input",debounce(e=>applyQuery(e.target.value)));
  searchMobile?.addEventListener("input",debounce(e=>applyQuery(e.target.value)));
  openSearchBtn?.addEventListener("click",()=>{ const bar=$("#mobileSearchBar"); const hidden=bar.classList.toggle("hidden"); openSearchBtn.setAttribute('aria-expanded', String(!hidden)); $("#searchMobile")?.focus() });

  // Keyboard UX
  document.addEventListener('keydown',(e)=>{
    if(e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){ e.preventDefault(); search?.focus(); }
    if(e.key === 'Escape'){ closeModal(details); closeModal(filtersSheet); }
  });

  // Explore smooth scroll
  btnExplore.addEventListener("click",(e)=>{ e.preventDefault(); document.getElementById("list").scrollIntoView({behavior:"smooth"}) });

  // Pagination
  prevPageBtn.addEventListener("click",()=>{ state.page=Math.max(1,state.page-1); render(); saveUIState(); });
  nextPageBtn.addEventListener("click",()=>{ const total=filterData().length; const totalPages=Math.ceil(total/state.perPage); state.page=Math.min(totalPages,state.page+1); render(); saveUIState(); });

  // Comments demo
  commentBtn.addEventListener('click',()=>{ const box = $("#commentBox"); const v = box.value.trim(); if(!v) return; const card = document.createElement('div'); card.className='rounded-lg bg-zinc-800 p-3 text-sm'; card.innerHTML = `<span class="font-semibold">Misafir</span> • <span class="text-zinc-400">${fmt.format(new Date())}</span><p class="mt-1"></p>`; card.querySelector('p').textContent=v; commentsContainer.prepend(card); box.value=''; });

  // ====== Auth Event Listeners ======
  switchAuth.addEventListener("click", ()=> openAuth(!isRegister));
  closeAuth.addEventListener("click", closeAuthModal);
  
  openLogin.addEventListener("click", ()=>{
    const u = getCurrentUser();
    if(u){
      localStorage.removeItem("aikoshi-current");
      $("#userTitle").textContent = "Profilim";
      $("#userPanel .mb-5 h4").textContent = "Misafir Kullanıcı";
      $("#userPanel .mb-5 p").textContent = "0 puan";
      openLogin.textContent = "Giriş Yap";
      alert("Çıkış yapıldı.");
    }else{
      openAuth(false);
    }
  });

  authSubmit.addEventListener("click", ()=>{
    const email = authEmail.value.trim();
    const pass  = authPass.value.trim();
    const name  = authUser.value.trim();
    let users   = getUsers();

    if(!email || !pass || (isRegister && !name)){
      authError.textContent = "Lütfen tüm alanları doldurun.";
      authError.classList.remove("hidden");
      return;
    }

    if(isRegister){
      if(users.find(u=>u.email===email)){
        authError.textContent = "Bu e-posta zaten kayıtlı.";
        authError.classList.remove("hidden");
        return;
      }
      const newUser = { email, password: pass, username: name };
      users.push(newUser); saveUsers(users); setCurrentUser(newUser);
      updateProfile(); closeAuthModal();
    }else{
      const u = users.find(u=>u.email===email && u.password===pass);
      if(!u){
        authError.textContent = "E-posta veya şifre hatalı.";
        authError.classList.remove("hidden");
        return;
      }
      setCurrentUser(u); updateProfile(); closeAuthModal();
    }
  });

  // ====== Init ======
  function init(){
    $("#year").textContent=new Date().getFullYear();
    loadUIState();

    // Restore theme first for flicker-free UI
    setTheme(state.theme);

    // Consent restore
    state.only18 = state.only18 && getAdultConsent();
    toggleKnob.firstElementChild.style.transform = state.only18 ? "translateX(1.25rem)" : "translateX(0)";
    document.documentElement.classList.toggle("adult-mode", state.only18);

    // Sync controls
    filterType.value = state.type; sortSel.value = state.sort; filterRating.value = state.minRating; ratingRange.value = state.minRating; ratingValue.textContent = state.minRating; search.value = state.query; searchMobile.value = state.query;

    const u = getCurrentUser();
    if(u){ updateProfile(); }

    renderTrendTags();
    renderTagCloud();
    render();
  }
  init();
  </script>
</body>
</html>
